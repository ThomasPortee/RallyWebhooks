<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
</head>
<body>
<h1 id="webhookmessenger">webhook-messenger</h1>
<p>This is a reflector that updates a number of attributes.</p>
<ul>
<li>Portfolio Item Investment Category - Automatically updated to match the Investment Category of the parent</li>
<li>User Story Release - Automatically updated to match the release of the parent Feature</li>
<li>Portfolio Item c_SendEpictoSNOWIndicatorDSEONLY - Automatically cleared if set on newly created items</li>
<li>Portfolio Item c_SNOWStatusDontTouchAdminONLY - Automatically cleared if set on newly created items</li>
</ul>
<p>It uses Agile Central webhooks to be notified of changes, and is designed to be deployed using AWS Lambda
(however it can easily be run as a stand-alone Node.js application).</p>
<h2 id="serverlessdeployment">Serverless Deployment</h2>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>Node.js 6.x+</li>
<li>A terminal</li>
</ul>
<h2 id="updatingadeployment">Updating a deployment</h2>
<ol>
<li>Follow the <code>Removing a deployment</code> steps in the README from the <strong>PRIOR</strong> version.</li>
<li>Follow the <code>Full Deployment Walkthrough</code> steps in the README from the <strong>CURRENT</strong> version.</li>
</ol>
<h2 id="fulldeploymentwalkthrough">Full Deployment Walkthrough</h2>
<h3 id="setup">Setup</h3>
<ol>
<li>Download the following files: <code>cox-webhook-reflector_&lt;version&gt;.zip</code></li>
<li><code>unzip cox-webhook-reflector_&lt;version&gt;.zip -d cox-webhook-reflector_&lt;version&gt;</code></li>
<li><code>cd cox-webhook-reflector_&lt;version&gt;</code></li>
<li><code>npm install yarn</code></li>
<li><code>./node_modules/.bin/yarn</code></li>
<li><code>cp setup.sh.example setup.sh</code></li>
<li>Edit <code>setup.sh</code> and fill in the required values.</li>
<li><code>source setup.sh</code></li>
<li>(Optional) If your environment requires AWS Lamda to run using pre-existing IAM Roles.<ol>
<li>Edit <code>serverless.yml</code></li>
<li>Add the <code>role: Your_Role_ARN</code> in the <code>provider</code> section. It should look like:
<code>
provider:
   name: aws
   role: Your_Role_ARN
   runtime: nodejs6.10
   ...
</code></li></ol></li>
</ol>
<h3 id="deploythereflectorcode">Deploy the reflector code</h3>
<ol>
<li><code>npm run deploy</code> - This deploys the reflector code to AWS Lambda</li>
<li>Test the labmdas by loading the value displayed for the <code>GET</code> endpoint in a web browser. It should say
<code>Thank you for visiting</code>.</li>
</ol>
<h3 id="deploythewebhooks">Deploy the webhooks</h3>
<ol>
<li>Edit <code>setup.sh</code> and set the value of <code>WEBHOOK_TARGET_URL=</code> to the value of the <code>POST</code> endpoint from the above deploy step output, or run <code>npm run info</code> to display the endpoint.</li>
<li><code>source setup.sh</code>   </li>
<li><code>npm run create-webhooks</code> - This creates the webhooks in Agile Central</li>
<li>Test the webhooks:<ul>
<li>Update a portfolio item <code>InvestmentCategory</code> in the workspace. You should see log output after a few seconds, and see child Portfolio Items InvestmentCategory updated to match the parent when you reload the children items in Agile Central.</li>
<li>Create a portfolio item with <code>Send Epic to SNOW Indicator (DSE ONLY)</code> or <code>SNOW Status (Don't Touch Admin ONLY)</code> set. After a few seconds the reflector
will clear these values as they should not be set if user copies a portfolio item with them set. </li></ul></li>
</ol>
<h2 id="removingadeployment">Removing a deployment</h2>
<ol>
<li><code>source setup.sh</code> - Make sure the values in <code>setup.sh</code> are set as described above</li>
<li><code>npm run delete-webhooks</code> - This will remove all webhooks in all workspaces related to this reflector.</li>
<li><code>npm run undeploy</code> - This will remove the AWS Lambda reflector code.</li>
</ol>
<h2 id="rollingupdateofanexistingdeployment">Rolling update of an existing deployment</h2>
<ol>
<li>Follow the steps for <code>Full Deployment Walkthrough</code> for the new version.</li>
<li>Once it is running, follow the steps for the <code>Removing a deployment</code> in the old version.</li>
</ol>
<h2 id="monitorreflectorlogs">Monitor reflector logs</h2>
<ol>
<li><code>./node_modules/.bin/serverless logs -f app -t</code></li>
</ol>
<h2 id="listingdeployedwebhooks">Listing deployed webhooks</h2>
<ol>
<li><code>source setup.sh</code> - Make sure the values in <code>setup.sh</code> are set as described above</li>
<li><code>npm run list-webhooks</code></li>
</ol>
<h2 id="enablingthereflectorforadditionalagilecentralworkspaces">Enabling the reflector for additional Agile Central Workspaces</h2>
<p>The same AWS lambda deployed above can be used by multiple workspaces. However, the webhooks are
workspace specific.</p>
<p>First, make sure your AWS lambda's are still deployed:</p>
<ol>
<li><code>npm run info</code></li>
</ol>
<p>Then, make sure the API key and target environment variables are set:</p>
<ol>
<li><code>export WEBHOOK_RALLY_API_KEY=</code> - See above for value</li>
<li><code>export WEBHOOK_TARGET_URL=</code> - See above for value</li>
</ol>
<p>Then, for each additional workspace you want to enable:</p>
<ol>
<li><code>export WEBHOOK_RALLY_WORKSPACE_UUID=&lt;UUID of that workspace&gt;</code></li>
<li><code>npm run create-webhooks</code></li>
</ol>
<h2 id="securitynotes">Security Notes</h2>
<p>The reflector is structured as Node.js code which is deployed as an AWS Lambda, triggered by AWS API Gateway.
The API Gateway is configured to be an HTTPS endpoint with an "unguessable" path. <code>GET</code> or <code>POST</code> requests to
this path will trigger the Lambda code. All other requests will be rejected by the API Gateway.  This path can
be configued at deployment time by editing <code>package.json</code> and setting a random value to <code>TARGET_URL_SUFFIX</code>.</p>
<p>The data sent by the webhook from Agile Central to the Lambda over HTTPS includes full detail (without attachments) of new
or modified Portfolio Items or User Stories (HierarchicalRequirements).</p>
<p>The AWS Lambda uses environment variables that contain a Agile Central API key, and Agile Central workspace ID to
query and update Agile Central over HTTPS. The data returned from Agile Central contains information about Portfolio Items and User Stories,
including:</p>
<ul>
<li>URL</li>
<li>Name</li>
<li>Children URLs</li>
<li>Investment Category</li>
<li>Release</li>
<li>FormattedID</li>
</ul>
<p>Data that is updated in Agile Central includes the following fields:</p>
<ul>
<li>Investment Category</li>
<li>Release</li>
</ul>
<p>The primary risk is that someone other than Agile Central triggers the Lambda code with a carefully crafted
message which would cause the Lambda to update data in the Agile Central. This risk is migitaged by the following:</p>
<ul>
<li>bad actor would need to know the "unguessable" portion of the path. This is only available to someone with access
to the AWS account containing the deployment OR subscription admin access to Agile Central.</li>
<li>bad actor would need to know the subscription ID and valid artifact references from Agile Central.  This is only
available to users that already have read access to Agile Central.</li>
</ul>
<p>The environment variables used during the deployment contain API keys for an Agile Central subscription admin.
These should be treated as passwords and not stored on an deployed environment.</p>
<h2 id="testplan">Test Plan</h2>
<h3 id="snowfields">SNOW Fields</h3>
<p><code>Send Epic to Snow Indicator (DSE Only)</code> and <code>Snow Status (Don't Touch Admin Only)</code></p>
<h4 id="feature">Feature</h4>
<table>
<thead>
<tr>
<th style="text-align:left;">Test</th>
<th style="text-align:center;"></th>
<th style="text-align:left;">Expected Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">create new without SNOW fields set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">new has has SNOW fields blank</td>
</tr>
<tr>
<td style="text-align:left;">create new with Snow Indicator</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">new item has SNOW Indicator cleared</td>
</tr>
<tr>
<td style="text-align:left;">create new with Snow Status</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">new item has Snow status cleared</td>
</tr>
<tr>
<td style="text-align:left;">create new with Snow Indicator an Snow Status</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">new item has SNOW fields blank</td>
</tr>
<tr>
<td style="text-align:left;">copy new without SNOW fields set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">new item has SNOW fields blank</td>
</tr>
<tr>
<td style="text-align:left;">copy new with Snow Indicator</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">new item Snow Indicator cleared</td>
</tr>
<tr>
<td style="text-align:left;">copy new with Snow Status</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">new item Snow Status cleared</td>
</tr>
<tr>
<td style="text-align:left;">copy new with Snow Indicator an Snow Status</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">new item Snow Status and Snow Indicator cleared</td>
</tr>
</tbody>
</table>
<h4 id="epic">Epic</h4>
<p>Same tests as Feature but at Epic level</p>
<h4 id="investment">Investment</h4>
<p>Same tests as Feature but at Investment level</p>
<h4 id="businessinitiative">Business Initiative</h4>
<p>Same tests as Feature but at Business Initiative level</p>
<h3 id="release">Release</h3>
<table>
<thead>
<tr>
<th style="text-align:left;">Test</th>
<th style="text-align:center;"></th>
<th style="text-align:left;">Expected Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">create story without parent, release unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;"><strong>TODO</strong></td>
</tr>
<tr>
<td style="text-align:left;">create story without parent, release set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;"><strong>TODO</strong></td>
</tr>
<tr>
<td style="text-align:left;">create story with parent, release unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;"><strong>TODO</strong></td>
</tr>
<tr>
<td style="text-align:left;">create story with parent, release set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;"><strong>TODO</strong></td>
</tr>
<tr>
<td style="text-align:left;">update story release, without parent</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;"><strong>TODO</strong></td>
</tr>
<tr>
<td style="text-align:left;">update story release, with parent with release unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;"><strong>TODO</strong></td>
</tr>
<tr>
<td style="text-align:left;">update story release, with parent with release set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;"><strong>TODO</strong></td>
</tr>
</tbody>
</table>
<h3 id="investmentcategoryic">Investment Category (IC)</h3>
<h4 id="businessinitiative-1">Business Initiative</h4>
<table>
<thead>
<tr>
<th style="text-align:left;">Test</th>
<th style="text-align:center;"></th>
<th style="text-align:left;">Expected Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">create with IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains unset</td>
</tr>
<tr>
<td style="text-align:left;">create with IC set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains set</td>
</tr>
<tr>
<td style="text-align:left;">change IC does not update descendents ICs</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">descendents ICs unchanged</td>
</tr>
</tbody>
</table>
<h4 id="investment-1">Investment</h4>
<table>
<thead>
<tr>
<th style="text-align:left;">Test</th>
<th style="text-align:center;"></th>
<th style="text-align:left;">Expected Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">create without parent, leave IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is "None"</td>
</tr>
<tr>
<td style="text-align:left;">create without parent, set IC</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is set value</td>
</tr>
<tr>
<td style="text-align:left;">create with parent IC unset, leave IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is "None"</td>
</tr>
<tr>
<td style="text-align:left;">create with parent IC unset, set IC</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is set value</td>
</tr>
<tr>
<td style="text-align:left;">create with parent IC set, leave IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is "None" (ignores parent BI)</td>
</tr>
<tr>
<td style="text-align:left;">create with parent IC set, set IC</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is set value (ignores parent BI)</td>
</tr>
<tr>
<td style="text-align:left;">change IC without parent</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is new value</td>
</tr>
<tr>
<td style="text-align:left;">change IC with parent IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is new value</td>
</tr>
<tr>
<td style="text-align:left;">change IC with parent IC set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is new valeu (ignores parent BI)</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC unset to no parent</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains unset</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC set to no parent</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains set</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC unset to parent with IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains unset</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC set to parent with IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains set</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC unset to parent with IC set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains set (ignores parent BI)</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC set to parent with IC set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC updated to parent value</td>
</tr>
<tr>
<td style="text-align:left;">change IC updates descendents</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">descendent ICs updated</td>
</tr>
<tr>
<td style="text-align:left;">reparent does not update descendents</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">descendent ICs unchanged (ignores parent BI)</td>
</tr>
</tbody>
</table>
<h4 id="epic-1">Epic</h4>
<table>
<thead>
<tr>
<th style="text-align:left;">Test</th>
<th style="text-align:center;"></th>
<th style="text-align:left;">Expected Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">same tests as Feature</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;"><strong>TODO</strong></td>
</tr>
<tr>
<td style="text-align:left;">change IC updates descendents</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">descendent ICs updated</td>
</tr>
<tr>
<td style="text-align:left;">reparent updates descendents</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">descendent ICs updated to match new parent</td>
</tr>
</tbody>
</table>
<h4 id="feature-1">Feature</h4>
<table>
<thead>
<tr>
<th style="text-align:left;">Test</th>
<th style="text-align:center;"></th>
<th style="text-align:left;">Expected Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">create without parent, leave IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is "None"</td>
</tr>
<tr>
<td style="text-align:left;">create without parent, set IC</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is set value</td>
</tr>
<tr>
<td style="text-align:left;">create with parent IC unset, leave IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is "None"</td>
</tr>
<tr>
<td style="text-align:left;">create with parent IC unset, set IC</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is set value</td>
</tr>
<tr>
<td style="text-align:left;">create with parent IC set, leave IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC reset to parent IC value</td>
</tr>
<tr>
<td style="text-align:left;">create with parent IC set, set IC</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC updated to parent value</td>
</tr>
<tr>
<td style="text-align:left;">change IC without parent</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is new value</td>
</tr>
<tr>
<td style="text-align:left;">change IC with parent IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC is new value</td>
</tr>
<tr>
<td style="text-align:left;">change IC with parent IC set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC updated to parent value</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC unset to no parent</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains unset</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC set to no parent</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains set</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC unset to parent with IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains unset</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC set to parent with IC unset</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC remains set</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC unset to parent with IC set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC updated to parent value</td>
</tr>
<tr>
<td style="text-align:left;">reparent with IC set to parent with IC set</td>
<td style="text-align:center;">-</td>
<td style="text-align:left;">IC updated to parent value</td>
</tr>
</tbody>
</table>
<h2 id="limitations">Limitations</h2>
<ol>
<li>Assumes that Portfolio Item Hierarchy is <code>BusinessInitiative</code> -&gt; <code>Investment</code> -&gt; <code>Epic</code> -&gt; <code>Feature</code></li>
<li>Assumes that an unset Portfolio Item InvestmentCategory value is <code>None</code></li>
</ol>
<h2 id="possibleenhancements">Possible Enhancements</h2>
<ol>
<li>Lambda encrypt environment variable at rest</li>
<li>Recommended service users for webhook creation and reflector</li>
<li>Improved log messages</li>
<li>Readme clarification</li>
<li>Node install</li>
<li>Terminal / Powershell</li>
<li>Proxy setup in NPM</li>
<li>Cloud 9 as standardized environment</li>
<li>Automate get Workspace UUID</li>
<li>Troubleshooting steps, coorrective actions</li>
</ol>
<h2 id="developerinformation">Developer Information</h2>
<p>See <a href="./DEVELOPER_README.md">DEVELOPER_README</a></p>
</body>
</html>